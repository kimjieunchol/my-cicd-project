{"ast":null,"code":"// NoticeChat.js\nimport React,{useState,useEffect,useRef,useCallback}from\"react\";import{Send,Bot,User,Sparkles,AlertCircle,Wifi,WifiOff}from\"lucide-react\";import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const WS_URL=\"ws://localhost:8080/ws/notice\";// 네이티브 WebSocket 엔드포인트\nconst NoticeChat=()=>{const[messages,setMessages]=useState([{id:1,type:\"bot\",text:\"안녕하세요! A_hub 공지 챗봇입니다. 궁금한 공지사항을 물어보세요! ✨\",timestamp:new Date()}]);const[input,setInput]=useState(\"\");const[isTyping,setIsTyping]=useState(false);const[connectionStatus,setConnectionStatus]=useState(\"disconnected\");const[error,setError]=useState(null);const wsRef=useRef(null);const messagesEndRef=useRef(null);const reconnectTimeoutRef=useRef(null);const messageIdRef=useRef(2);const heartbeatIntervalRef=useRef(null);// 자동 스크롤\nconst scrollToBottom=useCallback(()=>{var _messagesEndRef$curre;(_messagesEndRef$curre=messagesEndRef.current)===null||_messagesEndRef$curre===void 0?void 0:_messagesEndRef$curre.scrollIntoView({behavior:\"smooth\"});},[]);// 메시지 추가 함수\nconst addMessage=useCallback(function(type,text){let error=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;const newMessage={id:messageIdRef.current++,type,text,timestamp:new Date(),error};setMessages(prev=>[...prev,newMessage]);},[]);// WebSocket 연결 함수\nconst connectWebSocket=useCallback(()=>{try{setError(null);setConnectionStatus(\"connecting\");const ws=new WebSocket(WS_URL);ws.onopen=()=>{console.log(\"WebSocket connected\");setConnectionStatus(\"connected\");setError(null);// 연결 확인 메시지 전송\nws.send(JSON.stringify({type:\"connect\",timestamp:new Date().toISOString()}));// 하트비트 설정\nheartbeatIntervalRef.current=setInterval(()=>{if(ws.readyState===WebSocket.OPEN){ws.send(JSON.stringify({type:\"ping\"}));}},30000);// 30초마다 ping\n};ws.onmessage=event=>{try{const data=JSON.parse(event.data);// 메시지 타입에 따라 처리\nswitch(data.type){case\"message\":case\"chat\":setIsTyping(false);addMessage(\"bot\",data.message||data.text||data.content);break;case\"error\":setIsTyping(false);addMessage(\"bot\",data.message||\"오류가 발생했습니다.\",true);break;case\"typing\":setIsTyping(true);// 5초 후 자동으로 타이핑 상태 해제\nsetTimeout(()=>setIsTyping(false),5000);break;case\"pong\":// 하트비트 응답 - 로그만 출력\nconsole.log(\"Received pong\");break;default:// 일반 텍스트 메시지로 처리\nif(data.message||data.text){setIsTyping(false);addMessage(\"bot\",data.message||data.text);}break;}}catch(err){console.error(\"Message parsing error:\",err);// 파싱 실패 시 원본 메시지 표시\nsetIsTyping(false);addMessage(\"bot\",event.data);}};ws.onerror=error=>{console.error(\"WebSocket error:\",error);setError(\"연결 중 오류가 발생했습니다.\");};ws.onclose=event=>{console.log(\"WebSocket closed:\",event.code,event.reason);setConnectionStatus(\"disconnected\");setIsTyping(false);// 하트비트 정리\nif(heartbeatIntervalRef.current){clearInterval(heartbeatIntervalRef.current);heartbeatIntervalRef.current=null;}// 정상 종료가 아닌 경우 자동 재연결\nif(event.code!==1000){setError(\"연결이 끊어졌습니다. 재연결을 시도합니다...\");if(reconnectTimeoutRef.current){clearTimeout(reconnectTimeoutRef.current);}reconnectTimeoutRef.current=setTimeout(connectWebSocket,3000);}};wsRef.current=ws;}catch(error){console.error(\"Failed to connect:\",error);setConnectionStatus(\"disconnected\");setError(\"연결 설정 중 오류가 발생했습니다.\");}},[addMessage]);// 메시지 전송\nconst sendMessage=useCallback(()=>{if(!input.trim())return;const ws=wsRef.current;if(ws&&ws.readyState===WebSocket.OPEN){try{// 사용자 메시지 추가\naddMessage(\"user\",input);// 서버로 메시지 전송\nws.send(JSON.stringify({type:\"chat\",message:input,timestamp:new Date().toISOString()}));setInput(\"\");setIsTyping(true);// 타이핑 상태 자동 해제 (10초 후)\nsetTimeout(()=>{setIsTyping(false);},10000);}catch(error){console.error(\"Failed to send message:\",error);setIsTyping(false);addMessage(\"bot\",\"메시지 전송 중 오류가 발생했습니다. 다시 시도해주세요.\",true);}}else{addMessage(\"bot\",\"서버에 연결되지 않았습니다. 잠시만 기다려주세요.\",true);}},[input,addMessage]);// 연결 해제 함수\nconst disconnect=useCallback(()=>{if(heartbeatIntervalRef.current){clearInterval(heartbeatIntervalRef.current);heartbeatIntervalRef.current=null;}if(wsRef.current){wsRef.current.close(1000,\"User disconnected\");wsRef.current=null;}},[]);// 수동 재연결\nconst handleReconnect=useCallback(()=>{disconnect();setTimeout(connectWebSocket,1000);},[disconnect,connectWebSocket]);// 추천 질문 클릭 핸들러\nconst handleSuggestionClick=useCallback(suggestion=>{setInput(suggestion);},[]);// 키보드 이벤트\nconst handleKeyDown=useCallback(e=>{if(e.key===\"Enter\"&&!e.shiftKey){e.preventDefault();sendMessage();}},[sendMessage]);// 연결 상태에 따른 스타일\nconst getConnectionStatusColor=()=>{switch(connectionStatus){case\"connected\":return\"bg-green-400\";case\"connecting\":return\"bg-yellow-400 animate-pulse\";case\"disconnected\":return\"bg-red-400\";default:return\"bg-gray-400\";}};const getConnectionIcon=()=>{return connectionStatus===\"connected\"?/*#__PURE__*/_jsx(Wifi,{className:\"w-4 h-4 text-white\"}):/*#__PURE__*/_jsx(WifiOff,{className:\"w-4 h-4 text-white\"});};// 컴포넌트 마운트/언마운트\nuseEffect(()=>{connectWebSocket();return()=>{if(reconnectTimeoutRef.current){clearTimeout(reconnectTimeoutRef.current);}disconnect();};},[connectWebSocket,disconnect]);// 메시지 추가 시 스크롤\nuseEffect(()=>{scrollToBottom();},[messages,scrollToBottom]);const isConnected=connectionStatus===\"connected\";return/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white rounded-2xl shadow-xl border border-gray-100 overflow-hidden\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"bg-gradient-to-r from-blue-600 via-purple-600 to-blue-700 px-6 py-4\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-3\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"relative\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-10 h-10 bg-white/20 rounded-full flex items-center justify-center backdrop-blur-sm\",children:/*#__PURE__*/_jsx(Bot,{className:\"w-6 h-6 text-white\"})}),/*#__PURE__*/_jsx(\"div\",{className:\"absolute -top-1 -right-1 w-4 h-4 \".concat(getConnectionStatusColor(),\" rounded-full border-2 border-white flex items-center justify-center\"),children:connectionStatus===\"connecting\"?null:getConnectionIcon()})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex-1\",children:[/*#__PURE__*/_jsx(\"h3\",{className:\"text-white font-semibold text-lg\",children:\"A_hub \\uACF5\\uC9C0 \\uC5B4\\uC2DC\\uC2A4\\uD134\\uD2B8\"}),/*#__PURE__*/_jsxs(\"p\",{className:\"text-blue-100 text-sm\",children:[connectionStatus===\"connected\"&&\"항상 도움을 드릴 준비가 되어있어요\",connectionStatus===\"connecting\"&&\"서버에 연결하는 중...\",connectionStatus===\"disconnected\"&&\"연결이 끊어졌습니다\"]})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2\",children:[error&&/*#__PURE__*/_jsx(AlertCircle,{className:\"w-5 h-5 text-red-300\"}),/*#__PURE__*/_jsx(Sparkles,{className:\"w-5 h-5 text-yellow-300 animate-pulse\"})]})]})}),error&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-red-50 border-b border-red-200 px-4 py-2\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2 text-red-700 text-sm\",children:[/*#__PURE__*/_jsx(AlertCircle,{className:\"w-4 h-4\"}),/*#__PURE__*/_jsx(\"span\",{children:error}),/*#__PURE__*/_jsx(\"button\",{onClick:handleReconnect,className:\"ml-auto px-2 py-1 text-xs bg-red-100 hover:bg-red-200 rounded transition-colors\",children:\"\\uB2E4\\uC2DC \\uC5F0\\uACB0\"})]})}),!isConnected&&!error&&/*#__PURE__*/_jsx(\"div\",{className:\"bg-blue-50 border-b border-blue-200 px-4 py-2\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-center space-x-2 text-blue-700 text-sm\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-4 h-4 border-2 border-blue-400 border-t-transparent rounded-full animate-spin\"}),/*#__PURE__*/_jsx(\"span\",{children:\"\\uC11C\\uBC84 \\uC5F0\\uACB0\\uC744 \\uB300\\uAE30\\uC911\\uC785\\uB2C8\\uB2E4. \\uBC31\\uC5D4\\uB4DC \\uC11C\\uBC84\\uAC00 \\uC2E4\\uD589\\uB418\\uACE0 \\uC788\\uB294\\uC9C0 \\uD655\\uC778\\uD574\\uC8FC\\uC138\\uC694.\"})]})}),/*#__PURE__*/_jsxs(\"div\",{className:\"h-96 overflow-y-auto p-4 space-y-4 bg-gray-50\",children:[messages.map(msg=>/*#__PURE__*/_jsx(\"div\",{className:\"flex \".concat(msg.type===\"user\"?\"justify-end\":\"justify-start\",\" animate-fade-in\"),children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-start space-x-3 max-w-xs lg:max-w-md\",children:[msg.type===\"bot\"&&/*#__PURE__*/_jsx(\"div\",{className:\"w-8 h-8 \".concat(msg.error?\"bg-red-500\":\"bg-gradient-to-r from-blue-500 to-purple-500\",\" rounded-full flex items-center justify-center flex-shrink-0\"),children:msg.error?/*#__PURE__*/_jsx(AlertCircle,{className:\"w-5 h-5 text-white\"}):/*#__PURE__*/_jsx(Bot,{className:\"w-5 h-5 text-white\"})}),/*#__PURE__*/_jsxs(\"div\",{className:\"px-4 py-3 rounded-2xl shadow-sm \".concat(msg.type===\"user\"?\"bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-br-md\":msg.error?\"bg-red-50 text-red-800 rounded-bl-md border border-red-200\":\"bg-white text-gray-800 rounded-bl-md border border-gray-100\"),children:[/*#__PURE__*/_jsx(\"p\",{className:\"text-sm leading-relaxed\",children:msg.text}),/*#__PURE__*/_jsx(\"p\",{className:\"text-xs opacity-70 mt-1\",children:msg.timestamp.toLocaleTimeString()})]}),msg.type===\"user\"&&/*#__PURE__*/_jsx(\"div\",{className:\"w-8 h-8 bg-gradient-to-r from-gray-400 to-gray-500 rounded-full flex items-center justify-center flex-shrink-0\",children:/*#__PURE__*/_jsx(User,{className:\"w-5 h-5 text-white\"})})]})},msg.id)),isTyping&&/*#__PURE__*/_jsx(\"div\",{className:\"flex justify-start animate-fade-in\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex items-start space-x-3\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center\",children:/*#__PURE__*/_jsx(Bot,{className:\"w-5 h-5 text-white\"})}),/*#__PURE__*/_jsx(\"div\",{className:\"bg-white px-4 py-3 rounded-2xl rounded-bl-md border border-gray-100 shadow-sm\",children:/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-1\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"w-2 h-2 bg-blue-400 rounded-full animate-bounce\"}),/*#__PURE__*/_jsx(\"div\",{className:\"w-2 h-2 bg-blue-400 rounded-full animate-bounce\",style:{animationDelay:\"0.1s\"}}),/*#__PURE__*/_jsx(\"div\",{className:\"w-2 h-2 bg-blue-400 rounded-full animate-bounce\",style:{animationDelay:\"0.2s\"}})]})})]})}),/*#__PURE__*/_jsx(\"div\",{ref:messagesEndRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 border-t border-gray-100 bg-white\",children:[/*#__PURE__*/_jsxs(\"div\",{className:\"flex space-x-3 items-end\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex-1 relative\",children:/*#__PURE__*/_jsx(\"input\",{type:\"text\",value:input,onChange:e=>setInput(e.target.value),onKeyDown:handleKeyDown,placeholder:isConnected?\"공지사항에 대해 궁금한 것을 물어보세요...\":\"서버 연결을 기다리는 중...\",disabled:!isConnected,className:\"w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none resize-none bg-gray-50 text-gray-800 placeholder-gray-500 disabled:opacity-50 disabled:cursor-not-allowed\"})}),/*#__PURE__*/_jsx(\"button\",{onClick:sendMessage,disabled:!input.trim()||!isConnected,className:\"px-4 py-3 rounded-xl transition-all duration-200 \".concat(input.trim()&&isConnected?\"bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white shadow-lg hover:shadow-xl transform hover:scale-105\":\"bg-gray-200 text-gray-400 cursor-not-allowed\"),children:/*#__PURE__*/_jsx(Send,{className:\"w-5 h-5\"})})]}),/*#__PURE__*/_jsx(\"div\",{className:\"mt-3 flex flex-wrap gap-2\",children:[\"최신 공지 알려줘\",\"중요 공지가 뭐야?\",\"내 부서 공지는?\"].map((suggestion,idx)=>/*#__PURE__*/_jsx(\"button\",{onClick:()=>handleSuggestionClick(suggestion),disabled:!isConnected,className:\"px-3 py-1 text-xs bg-blue-50 text-blue-600 rounded-full hover:bg-blue-100 transition-colors border border-blue-200 disabled:opacity-50 disabled:cursor-not-allowed\",children:suggestion},idx))}),/*#__PURE__*/_jsxs(\"div\",{className:\"mt-2 text-xs text-gray-500 flex items-center justify-between\",children:[/*#__PURE__*/_jsxs(\"span\",{children:[\"\\uC0C1\\uD0DC:\",\" \",connectionStatus===\"connected\"?\"연결됨\":connectionStatus===\"connecting\"?\"연결 중...\":\"연결 끊김\"]}),/*#__PURE__*/_jsx(\"span\",{children:\"WebSocket \\uC5F0\\uACB0\"})]})]})]});};export default NoticeChat;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}